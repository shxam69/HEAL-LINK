<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEALINK | Smart Community Response</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- CORE STYLES --- */
        body { font-family: 'Plus Jakarta Sans', sans-serif; transition: background 0.5s ease; }
        
        /* --- ROLE-BASED THEMES --- */
        body.theme-patient { background: #EFF6FF; }
        body.theme-patient nav { background: rgba(255, 255, 255, 0.9); border-bottom: 1px solid #DBEAFE; }
        body.theme-patient .glass-panel { border-radius: 24px; border: 1px solid #BFDBFE; background: rgba(255, 255, 255, 0.8); box-shadow: 0 10px 30px -10px rgba(37, 99, 235, 0.1); }
        body.theme-patient .profile-header-bg { background: linear-gradient(135deg, #3B82F6, #2563EB); }

        body.theme-doctor { background: #F1F5F9; }
        body.theme-doctor nav { background: #0F172A; color: white; border-bottom: 4px solid #059669; }
        body.theme-doctor nav .nav-text { color: #CBD5E1; }
        body.theme-doctor nav .nav-title { color: white; }
        body.theme-doctor .glass-panel { border-radius: 8px; border: 1px solid #CBD5E1; background: white; box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1); }
        body.theme-doctor .profile-header-bg { background: linear-gradient(135deg, #0F172A, #059669); }

        body.theme-volunteer { background: #FFF7ED; }
        body.theme-volunteer nav { border-bottom: 2px solid #EA580C; }
        body.theme-volunteer .profile-header-bg { background: linear-gradient(135deg, #EA580C, #F97316); }

        /* --- UTILITIES --- */
        .hidden { display: none !important; }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; opacity: 0; transform: translateY(15px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        .hero-bg { background: radial-gradient(at top, #1e293b, #0f172a); }
        .pulse-ring { position: relative; }
        .pulse-ring::before { content: ''; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; background: rgba(239, 68, 68, 0.3); animation: pulse-ring 2s infinite; z-index: -1; }
        @keyframes pulse-ring { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; } }

        /* Chat Styles */
        .chat-bubble { max-width: 85%; padding: 12px 16px; border-radius: 12px; font-size: 0.9rem; margin-bottom: 8px; line-height: 1.5; }
        .chat-user { background: #2563EB; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background: #F1F5F9; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid #e2e8f0; }
        .chat-image-preview { max-width: 200px; border-radius: 8px; margin-top: 5px; border: 2px solid rgba(255,255,255,0.5); }
        .typing-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background: #94a3b8; animation: typing 1.4s infinite ease-in-out both; margin: 0 1px; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Toast */
        #toast-container { position: fixed; top: 90px; right: 24px; z-index: 9999; }
        .toast { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid #2563EB; animation: slideIn 0.3s; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        
        /* Language Dropdown */
        .lang-select { background: transparent; font-size: 0.8rem; font-weight: bold; color: #64748b; border: none; cursor: pointer; outline: none; }
        
        /* PROFILE STYLES */
        .profile-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .record-card { border: 1px dashed #cbd5e1; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; cursor: pointer; background: #f8fafc; }
        .record-card:hover { border-color: #3b82f6; background: #eff6ff; }
        .record-icon { font-size: 24px; margin-bottom: 8px; color: #64748b; }
        
        .form-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; font-size: 0.9rem; background: #f8fafc; transition: all 0.2s; }
        .form-input:focus { outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="bg-slate-50">

    <!-- --- NAVIGATION --- -->
    <nav id="main-nav" class="fixed w-full z-50 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-3 cursor-pointer" onclick="goHome()">
                    <div id="logo-icon" class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                        <i class="fa-solid fa-heart-pulse text-lg"></i>
                    </div>
                    <div>
                        <h1 class="nav-title font-bold text-2xl tracking-tight text-slate-800">HEALINK</h1>
                        <p id="role-badge" class="text-[10px] uppercase font-bold tracking-widest opacity-70 nav-text">Community</p>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-6">
                    <div id="nav-links" class="flex gap-4 text-sm font-medium nav-text text-slate-600 items-center">
                        <a href="#" onclick="goHome()" class="hover:text-blue-600 transition-colors">Home</a>
                        <a href="#features" class="hover:text-blue-600 transition-colors">Features</a>
                        <div class="h-4 w-px bg-slate-300"></div>
                        <button onclick="openSettings()" class="text-slate-400 hover:text-blue-600 transition-colors" title="AI Settings"><i class="fa-solid fa-gear"></i></button>
                    </div>
                    <div id="auth-buttons">
                        <button onclick="showLogin()" class="px-6 py-2.5 rounded-xl font-bold text-white bg-slate-900 hover:bg-slate-800 transition-all shadow-md active:scale-95">
                            Login / Register
                        </button>
                    </div>
                    
                    <!-- USER PROFILE NAV ITEM (Clickable) -->
                    <div id="user-profile" class="hidden flex items-center gap-4 pl-4 border-l border-slate-200">
                         <div class="text-right cursor-pointer group" onclick="openProfile()">
                            <p id="nav-username" class="nav-title text-sm font-bold text-slate-800 group-hover:text-blue-500 transition-colors">User</p>
                            <p id="nav-role" class="nav-text text-xs font-bold uppercase opacity-70">View Profile</p>
                        </div>
                        <button onclick="handleLogout()" class="text-red-500 hover:text-red-600" title="Logout"><i class="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- --- TOASTS --- -->
    <div id="toast-container"></div>

    <!-- --- MODALS --- -->
    
    <!-- 0. SETTINGS MODAL (API KEY) -->
    <div id="settings-modal" class="hidden overlay bg-black/60 z-[10002]">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl p-6 fade-in-up">
            <h3 class="text-lg font-bold text-slate-800 mb-2">AI Settings</h3>
            <p class="text-xs text-slate-500 mb-4">Enter your Gemini API Key to enable AI features (Chat & Analysis).</p>
            <div class="mb-4">
                <label class="form-label">Gemini API Key</label>
                <input type="password" id="settings-api-key" class="form-input" placeholder="AIzaSy...">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 text-slate-500 text-sm font-bold">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <!-- 1. PROFILE MODAL -->
    <div id="profile-modal" class="hidden overlay bg-black/60 z-[10000]">
        <div class="bg-white w-full max-w-2xl rounded-3xl shadow-2xl relative overflow-hidden fade-in-up m-4 h-[85vh] flex flex-col">
            <!-- Header Background -->
            <div class="h-32 profile-header-bg relative">
                <button onclick="closeProfile()" class="absolute top-4 right-4 bg-black/20 hover:bg-black/30 text-white rounded-full w-8 h-8 flex items-center justify-center transition-colors backdrop-blur">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
            
            <!-- Avatar & Main Info -->
            <div class="px-8 pb-6 flex flex-col items-center -mt-12">
                <div class="relative group cursor-pointer" onclick="alert('Upload Photo Simulation')">
                    <img src="" id="profile-avatar" class="profile-avatar bg-white">
                    <div class="absolute bottom-0 right-0 bg-slate-800 text-white w-8 h-8 rounded-full flex items-center justify-center border-2 border-white shadow-sm group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-camera text-xs"></i>
                    </div>
                </div>
                <h2 class="text-2xl font-bold text-slate-800 mt-3" id="profile-main-name">User Name</h2>
                <span class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 mt-1 uppercase" id="profile-main-role">Role</span>
            </div>

            <!-- Scrollable Form Area -->
            <div class="overflow-y-auto flex-1 px-8 pb-8">
                <form id="profile-form" onsubmit="event.preventDefault(); saveProfileChanges();">
                    <div class="mb-8">
                        <h3 class="text-sm font-bold text-slate-400 uppercase mb-4 border-b pb-2">Personal Details</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">Full Name</label><input type="text" id="p-name" class="form-input" disabled></div>
                            <div><label class="form-label">Age</label><input type="number" id="p-age" class="form-input" placeholder="Age"></div>
                            <div><label class="form-label">Location</label><input type="text" id="p-loc" class="form-input" placeholder="City, Country"></div>
                            <div><label class="form-label">Phone Number</label><input type="tel" id="p-phone" class="form-input" placeholder="+1 234 567 890"></div>
                        </div>
                    </div>
                    <div id="role-specific-section" class="mb-8">
                        <!-- Injected via JS -->
                    </div>
                    <div id="patient-records-section" class="hidden mb-8">
                        <h3 class="text-sm font-bold text-slate-400 uppercase mb-4 border-b pb-2 flex justify-between items-center">
                            Medical Records 
                            <button class="text-blue-600 text-xs hover:underline" type="button" onclick="triggerRecordUpload()">+ Upload New</button>
                        </h3>
                        <input type="file" id="record-upload-input" class="hidden" accept="image/*,.pdf" onchange="handleRecordUpload(this)">
                        <div class="grid grid-cols-3 gap-4" id="records-grid">
                            <div class="record-card">
                                <i class="fa-solid fa-file-pdf record-icon text-red-500"></i>
                                <span class="text-xs font-bold text-slate-600">Blood Report</span>
                                <span class="text-[10px] text-slate-400">Jan 12, 2026</span>
                            </div>
                            <div class="record-card border-dashed border-2 border-slate-300 bg-transparent hover:bg-slate-50" onclick="triggerRecordUpload()">
                                <i class="fa-solid fa-cloud-arrow-up record-icon"></i><span class="text-xs font-bold text-slate-500">Upload</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Footer Action -->
            <div class="p-4 border-t border-slate-100 bg-white flex justify-end gap-3">
                <button onclick="closeProfile()" class="px-6 py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-50 transition-colors">Close</button>
                <button onclick="saveProfileChanges()" class="px-8 py-2.5 rounded-xl font-bold text-white bg-slate-900 hover:bg-slate-800 shadow-lg transition-transform hover:-translate-y-0.5">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- 2. VIDEO CALL MODAL -->
    <div id="video-call-modal" class="hidden overlay bg-slate-900/95 z-[10001]">
        <div class="w-full max-w-4xl h-[80vh] bg-slate-800 rounded-2xl relative flex flex-col overflow-hidden shadow-2xl">
             <div class="absolute top-4 left-4 bg-black/40 px-3 py-1 rounded text-white text-xs flex items-center gap-2">
                 <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> LIVE
             </div>
             <div class="flex-1 flex items-center justify-center"><i class="fa-solid fa-user-injured text-8xl text-slate-600"></i></div>
             <div class="p-6 bg-slate-900 flex justify-center gap-6">
                 <button onclick="endCall()" class="w-14 h-14 rounded-full bg-red-600 text-white text-xl hover:bg-red-700 shadow-lg transform hover:scale-105"><i class="fa-solid fa-phone-slash"></i></button>
             </div>
        </div>
    </div>

    <!-- 3. SOS Countdown -->
    <div id="sos-countdown-overlay" class="hidden overlay bg-red-900/95 z-[10000]">
        <div class="text-center text-white fade-in-up">
            <div class="w-32 h-32 rounded-full border-4 border-white flex items-center justify-center text-6xl font-bold mb-6 mx-auto animate-ping" id="countdown-number">3</div>
            <h2 class="text-4xl font-bold mb-2">SENDING SOS</h2>
            <p class="text-lg opacity-80 mb-8">Alerting nearby Doctors & Volunteers...</p>
            <button onclick="cancelSOS()" class="bg-white text-red-600 px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-100 shadow-xl">CANCEL</button>
        </div>
    </div>

    <!-- --- LANDING PAGE --- -->
    <section id="landing-page" class="min-h-screen">
        <div class="hero-bg pt-32 pb-20 text-white relative overflow-hidden">
            <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
                <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 border border-white/20 text-sm font-medium backdrop-blur mb-8">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span> System Operational
                </div>
                <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight">
                    Healthcare, <span class="text-blue-400">Simplified.</span>
                </h1>
                <p class="text-lg md:text-xl text-slate-300 max-w-2xl mx-auto mb-10">
                    Connect instantly with doctors for emergencies or appointments.
                </p>
                <button onclick="showLogin()" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-bold text-lg shadow-xl transition-transform hover:-translate-y-1">
                    Get Started Now
                </button>
                <p id="local-mode-warning" class="mt-4 text-orange-300 text-sm hidden font-mono">⚠️ Running in Local Demo Mode</p>
            </div>
        </div>
    </section>

    <!-- --- LOGIN / SIGNUP --- -->
    <section id="login-section" class="hidden min-h-screen pt-28 pb-12 flex items-center justify-center px-4">
        <div class="glass-panel p-8 w-full max-w-md bg-white">
            <h2 class="text-2xl font-bold text-slate-800 mb-6 text-center">Welcome to HEALINK</h2>
            
            <!-- Tabs -->
            <div class="flex border-b border-slate-200 mb-6">
                <div class="w-1/2 text-center auth-tab active" id="tab-login" onclick="switchAuthTab('login')">Login</div>
                <div class="w-1/2 text-center auth-tab" id="tab-register" onclick="switchAuthTab('register')">Sign Up</div>
            </div>

            <!-- Login Form -->
            <div id="form-login" class="space-y-4">
                <input type="email" id="login-email" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Email Address">
                <input type="password" id="login-pass" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Password">
                <p class="text-xs text-slate-400 text-center">Note: Your role (Doctor/Patient) is linked to your email.</p>
                <button onclick="handleLogin()" id="login-submit-btn" class="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 shadow-lg mt-4">Login Securely</button>
            </div>

            <!-- Register Form -->
            <div id="form-register" class="space-y-4 hidden">
                <input type="text" id="reg-name" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Full Name">
                <input type="email" id="reg-email" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Email Address">
                <input type="tel" id="reg-phone" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Phone">
                
                <!-- Spec input for doctors -->
                <input type="text" id="reg-spec" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none hidden" placeholder="Specialization (e.g. Cardiologist)">

                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">I am a...</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="selectRegRole('patient')" class="role-btn p-3 rounded-xl border border-slate-200 hover:bg-blue-50 text-center transition-all" data-role="patient">
                            <i class="fa-solid fa-user text-xl text-blue-500 mb-1"></i><div class="text-[10px] font-bold">Patient</div>
                        </button>
                        <button onclick="selectRegRole('doctor')" class="role-btn p-3 rounded-xl border border-slate-200 hover:bg-emerald-50 text-center transition-all" data-role="doctor">
                            <i class="fa-solid fa-stethoscope text-xl text-emerald-600 mb-1"></i><div class="text-[10px] font-bold">Doctor</div>
                        </button>
                        <button onclick="selectRegRole('volunteer')" class="role-btn p-3 rounded-xl border border-slate-200 hover:bg-orange-50 text-center transition-all" data-role="volunteer">
                            <i class="fa-solid fa-hand-holding-heart text-xl text-orange-500 mb-1"></i><div class="text-[10px] font-bold">Volunteer</div>
                        </button>
                    </div>
                </div>

                <input type="password" id="reg-pass" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Create Password">
                <button onclick="handleSignup()" id="signup-submit-btn" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg mt-4">Create Account</button>
            </div>
        </div>
    </section>

    <!-- --- APP CONTAINER --- -->
    <main id="app-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-28 min-h-screen hidden">
        
        <!-- ================= PATIENT UI ================= -->
        <div id="patient-dash" class="hidden space-y-8 fade-in-up">
            <div class="flex justify-between items-end">
                <div>
                    <h2 class="text-3xl font-bold text-slate-800">My Wellness</h2>
                    <p class="text-slate-500">How are you feeling today, <span class="user-name-span"></span>?</p>
                </div>
                <button onclick="openProfile()" class="bg-white text-blue-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-blue-50 border border-blue-100 transition-all">
                    <i class="fa-solid fa-user-circle mr-2"></i> My Profile
                </button>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 space-y-8">
                    <div class="glass-panel p-8 text-center bg-gradient-to-br from-white to-blue-50 border-blue-100">
                        <button onclick="startSOSCountdown()" id="sos-btn" class="w-24 h-24 rounded-full bg-gradient-to-br from-red-500 to-red-600 text-white text-3xl shadow-xl hover:scale-105 transition-all pulse-ring mx-auto mb-4">
                            <i class="fa-solid fa-power-off"></i>
                        </button>
                        <h3 class="text-xl font-bold text-slate-800">Emergency Help</h3>
                        <p class="text-slate-500 text-sm">Press and hold for 3 seconds</p>
                        <div id="sos-status-box" class="hidden mt-4 p-3 bg-red-100 text-red-700 rounded-lg text-sm font-bold animate-pulse">
                            <i class="fa-solid fa-circle-notch fa-spin mr-2"></i> Broadcasting Live Location...
                        </div>
                    </div>
                    <div class="glass-panel p-6 bg-white">
                        <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-user-doctor text-blue-500"></i> Find a Specialist
                        </h3>
                        <div class="grid md:grid-cols-2 gap-4" id="patient-doc-list">
                             <p class="text-slate-400 text-sm col-span-2 text-center py-4">Loading doctors...</p>
                        </div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="glass-panel p-6 bg-white border-l-4 border-blue-500">
                        <h3 class="font-bold text-lg text-slate-800 mb-4">My Appointments</h3>
                        <div id="my-appointments-list" class="space-y-3">
                            <p class="text-slate-400 text-sm italic">No active bookings.</p>
                        </div>
                    </div>
                    <div class="glass-panel h-[400px] flex flex-col bg-white overflow-hidden relative">
                        <div class="bg-blue-600 p-4 text-white">
                            <h4 class="font-bold text-sm"><i class="fa-solid fa-robot mr-2"></i>Health Assistant ✨</h4>
                        </div>
                        <div id="patient-chat-box" class="flex-1 p-4 overflow-y-auto bg-slate-50 flex flex-col gap-2">
                            <div class="chat-bubble chat-ai">Hello! I'm your AI Medical Assistant (Gemini Powered). Describe symptoms or upload a photo.</div>
                        </div>
                        <div class="p-3 border-t flex gap-2">
                            <button onclick="triggerImageUpload()" class="text-slate-400 hover:text-blue-600 p-2"><i class="fa-solid fa-image"></i></button>
                            <input id="patient-chat-input" class="flex-1 bg-slate-100 rounded-full px-4 text-sm outline-none" placeholder="Type here...">
                            <button onclick="sendPatientChat()" class="w-8 h-8 bg-blue-600 text-white rounded-full"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*" onchange="handleImageUpload(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= DOCTOR UI ================= -->
        <div id="doctor-dash" class="hidden space-y-6 fade-in-up">
            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Clinical Dashboard</h2>
                    <p class="text-xs text-slate-500">Shift: 08:00 - 16:00 • Ward B</p>
                </div>
                <div class="flex gap-4 text-center items-center">
                    <button onclick="openProfile()" class="text-slate-500 hover:text-emerald-600 mr-2 flex items-center gap-2 text-xs font-bold uppercase transition-colors">
                        <i class="fa-solid fa-user-doctor text-lg"></i> Profile
                    </button>
                    <div class="border-l border-slate-200 pl-4"><p class="text-xs font-bold text-slate-400 uppercase">Waiting</p><p class="text-xl font-bold text-slate-800">4</p></div>
                    <div><p class="text-xs font-bold text-slate-400 uppercase">Treated</p><p class="text-xl font-bold text-emerald-600">12</p></div>
                    <button id="doc-status-toggle" onclick="toggleDocStatus()" class="px-4 py-2 bg-emerald-600 text-white rounded font-bold text-xs uppercase hover:bg-emerald-700">Available</button>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white border border-red-200 rounded-lg p-4">
                        <h3 class="text-sm font-bold text-red-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-bell animate-pulse"></i> Critical Alerts (SOS)</h3>
                        <div id="doctor-feed" class="space-y-2"><p class="text-xs text-slate-400 py-4 text-center">No active emergencies.</p></div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <h3 class="text-sm font-bold text-slate-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-list-check text-blue-600"></i> Incoming Requests</h3>
                        <div id="doctor-requests" class="space-y-2"><p class="text-xs text-slate-400 py-4 text-center">No pending requests.</p></div>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <h3 class="text-sm font-bold text-slate-700 uppercase mb-3 flex items-center gap-2"><i class="fa-solid fa-calendar-day text-emerald-600"></i> Today's Schedule</h3>
                        <div id="doctor-upcoming" class="space-y-2"><p class="text-xs text-slate-400 py-4 text-center">Schedule clear.</p></div>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-slate-800 rounded-lg overflow-hidden flex flex-col h-[500px]">
                        <div class="bg-slate-900 p-3 text-white border-b border-slate-700"><h4 class="font-bold text-xs uppercase tracking-wide"><i class="fa-solid fa-user-nurse mr-2"></i>Protocol Assistant</h4></div>
                        <div id="nurse-chat-box" class="flex-1 p-4 overflow-y-auto text-sm text-slate-300 flex flex-col gap-2">
                            <div class="p-2 bg-slate-700 rounded rounded-bl-none self-start max-w-[90%]">Ready for triage support. Ask for patient history or protocols.</div>
                        </div>
                        <div class="p-3 bg-slate-900 flex gap-2">
                            <input id="nurse-chat-input" class="flex-1 bg-slate-800 border border-slate-700 rounded px-3 py-1 text-sm text-white outline-none" placeholder="Command...">
                            <button onclick="sendNurseChat()" class="px-3 bg-emerald-600 text-white rounded hover:bg-emerald-700"><i class="fa-solid fa-paper-plane text-xs"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= VOLUNTEER UI ================= -->
        <div id="volunteer-dash" class="hidden space-y-8 fade-in-up">
            <div class="flex justify-between items-center">
                <h2 class="text-3xl font-bold text-slate-800">Community Response</h2>
                <button onclick="openProfile()" class="bg-white text-orange-600 px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:bg-orange-50 border border-orange-100 transition-all">
                    <i class="fa-solid fa-id-card mr-2"></i> Volunteer ID & Skills
                </button>
            </div>
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="glass-panel p-6 bg-white border-orange-200">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Nearby SOS</h3>
                    <div id="volunteer-feed" class="space-y-4"><p class="text-center text-slate-400">Scanning area...</p></div>
                </div>
                <div class="glass-panel p-6 bg-white">
                    <h3 class="font-bold text-lg text-slate-800 mb-4">Registered Doctors</h3>
                    <div id="volunteer-doc-list" class="grid gap-4"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- --- FIREBASE LOGIC --- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAQUeh5Xk93630N2YhsmjY7RGliLlNQ2dM",
          authDomain: "heal-link-6-9.firebaseapp.com",
          projectId: "heal-link-6-9",
          storageBucket: "heal-link-6-9.firebasestorage.app",
          messagingSenderId: "964871551667",
          appId: "1:964871551667:web:dffa9cf8e52cf312d00ec6"
        };

        // LOCAL/OFFLINE DETECTION
        let db, auth;
        let isLocalMode = false;
        let apiKey = "";

        // ----- LOCAL DB HELPER (SYNC ACROSS TABS) -----
        const LocalDB = {
            get: (col) => JSON.parse(localStorage.getItem(`healink_${col}`) || '[]'),
            add: (col, data) => {
                const current = LocalDB.get(col);
                current.push(data);
                localStorage.setItem(`healink_${col}`, JSON.stringify(current));
            },
            update: (col, id, data) => {
                const current = LocalDB.get(col);
                const idx = current.findIndex(i => i.id === id);
                if(idx !== -1) {
                    Object.assign(current[idx], data);
                    localStorage.setItem(`healink_${col}`, JSON.stringify(current));
                }
            }
        };

        try {
            if (window.location.protocol === 'file:') {
                isLocalMode = true;
                document.getElementById('local-mode-warning').classList.remove('hidden');
                auth = { currentUser: null };
                // Wrapper to switch between LocalDB and in-memory for session
                db = {}; 
            } else {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
            apiKey = localStorage.getItem('gemini_api_key') || "";
        } catch(e) { console.error("Init Error", e); }

        // STATE
        let state = {
            user: null, role: null, name: '',
            hasActiveAppt: false, sosTimer: null,
            profile: { 
                age: '24', blood: 'O+', location: 'New York, USA',
                contact: '555-0123', emergency: '555-9999', allergies: 'Peanuts', history: 'None',
                specialty: 'Cardiology', hospital: 'City General', license: 'MED-5599', exp: '5',
                vehicle: 'Motorbike', skills: 'CPR, First Aid'
            }
        };

        // --- AUTH & SETUP ---
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.saveSettings = () => {
            apiKey = document.getElementById('settings-api-key').value;
            localStorage.setItem('gemini_api_key', apiKey);
            document.getElementById('settings-modal').classList.add('hidden');
            showToast("API Key Saved!", "success");
        };

        window.switchAuthTab = (tab) => {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            if(tab === 'login') {
                document.getElementById('form-login').classList.remove('hidden');
                document.getElementById('form-register').classList.add('hidden');
            } else {
                document.getElementById('form-login').classList.add('hidden');
                document.getElementById('form-register').classList.remove('hidden');
            }
        };

        window.selectRegRole = (role) => {
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'bg-slate-200'));
            const btn = document.querySelector(`button[data-role="${role}"]`);
            btn.classList.add('ring-2', 'ring-offset-2', 'bg-slate-200');
            state.role = role;
            if (role === 'doctor') document.getElementById('reg-spec').classList.remove('hidden');
            else document.getElementById('reg-spec').classList.add('hidden');
        };

        // CORE FUNCTIONS
        async function runAuth(action, email, pass, name) {
            if (isLocalMode) {
                // MOCK AUTH + LOCAL STORAGE PERSISTENCE
                const uid = 'local-' + Date.now();
                state.user = { uid, email, displayName: name || email.split('@')[0] };
                if (!name) state.name = email.split('@')[0]; else state.name = name;
                
                // If login, try to find existing role in local storage (simulated) or default
                // For hackathon demo, we just trust the flow or use default
                if (!state.role) state.role = 'patient'; 
                
                // Persist doctor to LocalDB
                if(state.role === 'doctor') {
                     LocalDB.add('doctors', { id: uid, name: state.name, spec: document.getElementById('reg-spec').value || 'General', status: 'Available' });
                }
                
                // Set session storage to remember login on reload
                sessionStorage.setItem('healink_user', JSON.stringify({ uid, email, name: state.name, role: state.role }));
                
                enterApp();
                return;
            }
            if (action === 'login') {
                await signInWithEmailAndPassword(auth, email, pass);
            } else {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await updateProfile(cred.user, { displayName: name });
                await setDoc(doc(db, "users", cred.user.uid), { name, email, role: state.role, createdAt: serverTimestamp() });
                if(state.role === 'doctor') {
                     await setDoc(doc(db, "doctors", cred.user.uid), { name, spec: document.getElementById('reg-spec').value || 'General', status: 'Available', uid: cred.user.uid });
                }
            }
        }

        window.handleSignup = async () => {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            if(!name || !email || !pass || !state.role) return showToast("Please fill all fields", "error");
            try { await runAuth('signup', email, pass, name); } catch(e) { showToast(e.message, "error"); }
        };

        window.handleLogin = async () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            if(!email || !pass) return showToast("Enter credentials", "error");
            try { await runAuth('login', email, pass); } catch(e) { showToast("Login Failed", "error"); }
        };

        // INIT LOGIC
        // Check for local session first
        if (isLocalMode) {
            const savedUser = JSON.parse(sessionStorage.getItem('healink_user'));
            if(savedUser) {
                state.user = { uid: savedUser.uid, email: savedUser.email, displayName: savedUser.name };
                state.name = savedUser.name;
                state.role = savedUser.role;
                enterApp();
            }
        } else {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.user = user; state.name = user.displayName || "User";
                    try {
                        const snap = await getDoc(doc(db, "users", user.uid));
                        if(snap.exists()) { state.role = snap.data().role; enterApp(); }
                        else if(state.role) enterApp(); 
                        else { state.role = 'patient'; enterApp(); }
                    } catch(e) { console.log(e); if(state.role) enterApp(); }
                } else {
                    state.user = null;
                    document.getElementById('app-container').classList.add('hidden');
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('landing-page').classList.remove('hidden');
                }
            });
        }

        function enterApp() {
            document.body.className = `bg-slate-50 theme-${state.role}`;
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('nav-links').classList.add('hidden');
            document.getElementById('auth-buttons').classList.add('hidden');
            document.getElementById('user-profile').classList.remove('hidden');
            document.getElementById('user-profile').classList.add('flex');
            
            document.getElementById('nav-username').textContent = state.name;
            document.getElementById('nav-role').textContent = state.role.toUpperCase();
            document.querySelectorAll('.user-name-span').forEach(el => el.textContent = state.name);

            const logo = document.getElementById('logo-icon');
            if(state.role === 'doctor') logo.className = "w-10 h-10 bg-emerald-600 rounded flex items-center justify-center text-white";
            if(state.role === 'volunteer') logo.className = "w-10 h-10 bg-orange-600 rounded-full flex items-center justify-center text-white";

            if(state.role === 'patient') { document.getElementById('patient-dash').classList.remove('hidden'); initPatient(); }
            else if(state.role === 'doctor') { document.getElementById('doctor-dash').classList.remove('hidden'); initDoctor(); }
            else { document.getElementById('volunteer-dash').classList.remove('hidden'); initVolunteer(); }
        }

        window.showLogin = () => { document.getElementById('landing-page').classList.add('hidden'); document.getElementById('login-section').classList.remove('hidden'); };
        window.goHome = () => location.reload();
        window.handleLogout = () => { 
            if(isLocalMode) {
                sessionStorage.removeItem('healink_user');
                location.reload();
            } else signOut(auth).then(() => location.reload()); 
        };

        // DATA HANDLERS (HYBRID)
        function listen(colName, callback) {
            if (isLocalMode) {
                // Poll LocalStorage
                const getData = () => {
                    const data = LocalDB.get(colName);
                    callback({ empty: data.length===0, docs: data.map(d => ({ data: ()=>d, id: d.id })) });
                };
                getData();
                setInterval(getData, 1000);
            } else {
                onSnapshot(collection(db, colName), (snap) => callback({ empty: snap.empty, docs: snap.docs }));
            }
        }

        async function create(colName, data) {
            if (isLocalMode) { 
                data.id = Math.random().toString(36).substr(2,9); 
                LocalDB.add(colName, data);
                return; 
            }
            await addDoc(collection(db, colName), data);
        }

        async function update(colName, id, data) {
            if (isLocalMode) { 
                LocalDB.update(colName, id, data);
                return; 
            }
            await updateDoc(doc(db, colName, id), data);
        }

        // FEATURES & AI
        async function callGemini(prompt, system) {
            if(!apiKey) return "Please add your API Key in settings first.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: system }] } })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "AI Connection Error."; }
        }

        async function callGeminiVision(prompt, base64) {
            if(!apiKey) return "Please add your API Key in settings first.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
                });
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch(e) { return "AI Vision Error."; }
        }

        window.triggerRecordUpload = () => document.getElementById('record-upload-input').click();
        window.triggerImageUpload = () => document.getElementById('image-upload-input').click();

        window.handleRecordUpload = (input) => {
             if (input.files && input.files[0]) {
                 const file = input.files[0];
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     const grid = document.getElementById('records-grid');
                     const newCard = document.createElement('div');
                     newCard.className = 'record-card bg-blue-50 border-blue-200 relative overflow-hidden group';
                     let content = '';
                     if(file.type.startsWith('image/')) {
                         content = `<img src="${e.target.result}" class="w-full h-full object-cover absolute top-0 left-0"><div class="absolute bottom-0 w-full bg-black/50 text-white text-[10px] p-1 truncate">${file.name}</div>`;
                     } else {
                         content = `<i class="fa-solid fa-file-pdf record-icon text-red-500"></i><span class="text-xs font-bold text-slate-600 truncate w-full text-center">${file.name}</span>`;
                     }
                     newCard.innerHTML = content;
                     grid.insertBefore(newCard, grid.firstChild);
                     showToast("File Added", "success");
                 }
                 reader.readAsDataURL(file);
             }
        }

        window.handleImageUpload = (input) => {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(',')[1];
                    const box = document.getElementById('patient-chat-box');
                    box.innerHTML += `<div class="chat-bubble chat-user self-end bg-blue-600 text-white"><img src="${e.target.result}" class="chat-image-preview"></div>`;
                    
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'chat-bubble chat-ai self-start bg-slate-100 text-slate-700';
                    typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                    box.appendChild(typingDiv);
                    
                    const text = await callGeminiVision("Analyze this medical image or report and provide key insights.", base64);
                    typingDiv.remove();
                    box.innerHTML += `<div class="chat-bubble chat-ai self-start bg-slate-100 text-slate-700">${text}</div>`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        };

        // SMART MOCK AI (Integrated into Chat Flow)
        async function getAIResponse(prompt, context) {
            if (apiKey) {
                const system = context === "doctor" ? "You are a senior nurse assistant assisting a doctor. Provide protocols and medical data." : "You are a professional, empathetic medical AI assistant named HEALINK.";
                return await callGemini(prompt, system);
            }
            
            // Fallback to Smart Mock
            const p = prompt.toLowerCase();
            if (context === "doctor") {
                if(p.includes("protocol") || p.includes("procedure")) return "Standard Protocol: 1. Assess ABCs. 2. Establish IV access. 3. Monitor vitals.";
                return "I am standing by. Ask for protocols, drug info, or specialist referrals.";
            } else {
                if(p.includes("headache")) return "Headaches can be due to stress. If vision is blurred, seek help.";
                if(p.includes("fever")) return "Monitor temperature. Stay hydrated.";
                if(p.includes("chest") || p.includes("heart")) return "⚠️ CRITICAL: Chest pain is serious. Press SOS immediately.";
                return "I understand. Please describe your symptoms in more detail.";
            }
        }

        window.sendPatientChat = async () => {
            const val = document.getElementById('patient-chat-input').value;
            if(!val) return;
            const box = document.getElementById('patient-chat-box');
            box.innerHTML += `<div class="chat-bubble chat-user self-end bg-blue-600 text-white">${val}</div>`;
            document.getElementById('patient-chat-input').value = '';
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'chat-bubble chat-ai self-start bg-slate-100 text-slate-700';
            typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            box.appendChild(typingDiv);
            
            const text = await getAIResponse(val, "patient");
            
            typingDiv.remove();
            box.innerHTML += `<div class="chat-bubble chat-ai self-start bg-slate-100 text-slate-700">${text}</div>`;
            box.scrollTop = box.scrollHeight;
        };
        
        window.sendNurseChat = async () => {
             const val = document.getElementById('nurse-chat-input').value;
             if(!val) return;
             const box = document.getElementById('nurse-chat-box');
             box.innerHTML += `<div class="p-2 bg-slate-700 rounded rounded-br-none self-end text-white max-w-[90%]">${val}</div>`;
             document.getElementById('nurse-chat-input').value = '';
             
             const text = await getAIResponse(val, "doctor");

             box.innerHTML += `<div class="p-2 bg-slate-600 rounded rounded-bl-none self-start text-slate-200 max-w-[90%]">${text}</div>`;
             box.scrollTop = box.scrollHeight;
        };

        window.openProfile = () => {
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-main-name').innerText = state.name;
            document.getElementById('p-name').value = state.name;
            document.getElementById('p-age').value = state.profile.age;
            document.getElementById('p-loc').value = state.profile.location;
            document.getElementById('p-phone').value = state.profile.contact;
            
            const section = document.getElementById('role-specific-section');
            section.innerHTML = '';

            if (state.role === 'patient') {
                document.getElementById('patient-records-section').classList.remove('hidden');
                section.innerHTML = `<div class="grid grid-cols-2 gap-4"><div><label class="form-label">Blood Group</label><select id="f-blood" class="form-input"><option>O+</option><option>A+</option><option>B+</option></select></div><div><label class="form-label">Emergency Contact</label><input type="tel" id="f-emg" class="form-input" value="${state.profile.emergency}"></div><div class="col-span-2"><label class="form-label">Allergies</label><input type="text" id="f-allergies" class="form-input" value="${state.profile.allergies}"></div><div class="col-span-2"><label class="form-label">Medical History</label><textarea id="f-history" class="form-input h-20" placeholder="History...">${state.profile.history}</textarea></div></div>`;
            } else if (state.role === 'doctor') {
                document.getElementById('patient-records-section').classList.add('hidden');
                section.innerHTML = `<div class="space-y-4"><div><label class="form-label">Specialization</label><input type="text" id="f-spec" class="form-input" value="${state.profile.specialty}"></div><div><label class="form-label">Hospital</label><input type="text" id="f-hosp" class="form-input" value="${state.profile.hospital}"></div><div><label class="form-label">Experience (Years)</label><input type="number" id="f-exp" class="form-input" value="${state.profile.exp}"></div></div>`;
            }
        };

        window.closeProfile = () => document.getElementById('profile-modal').classList.add('hidden');
        window.saveProfileChanges = () => { showToast("Saved", "success"); closeProfile(); };
        window.simulateFileUpload = () => showToast("Uploaded", "success");

        function initPatient() {
            listen('doctors', (snap) => {
                const list = document.getElementById('patient-doc-list');
                list.innerHTML = '';
                if(snap.empty) { list.innerHTML = '<p class="text-slate-400 col-span-2 text-center py-4">No doctors registered.</p>'; return; }
                snap.docs.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `<div class="p-4 rounded-2xl bg-slate-50 border flex flex-col items-center text-center"><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center mb-2 shadow-sm"><i class="fa-solid fa-user-doctor text-slate-400"></i></div><h4 class="font-bold text-slate-800 text-sm">${data.name}</h4><p class="text-xs text-slate-500">${data.spec}</p><button onclick="bookAppt('${data.name}', '${d.id}')" class="w-full mt-3 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700">Book Now</button></div>`;
                });
            });
            listen('appointments', (snap) => {
                const list = document.getElementById('my-appointments-list');
                list.innerHTML = '';
                snap.docs.forEach(d => {
                    const data = d.data();
                    if(data.patientId === state.user.uid) {
                        let color = "bg-yellow-100 text-yellow-700";
                        if(data.status === 'accepted') color = "bg-green-100 text-green-700";
                        if(data.status === 'rejected') color = "bg-red-100 text-red-700";
                        list.innerHTML += `<div class="flex justify-between p-3 bg-slate-50 rounded-xl"><div><p class="font-bold text-sm text-slate-700">${data.doctorName}</p><p class="text-xs text-slate-500">Pending</p></div><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${color}">${data.status}</span></div>`;
                    }
                });
            });
        }

        window.bookAppt = async (name, id) => {
            await create('appointments', { doctorName: name, doctorId: id, patientName: state.name, patientId: state.user.uid, status: 'pending' });
            showToast("Request Sent", "success");
        };

        window.startSOSCountdown = () => {
            document.getElementById('sos-countdown-overlay').classList.remove('hidden');
            let count = 3;
            document.getElementById('countdown-number').textContent = count;
            state.sosTimer = setInterval(() => {
                count--;
                document.getElementById('countdown-number').textContent = count;
                if(count === 0) { clearInterval(state.sosTimer); document.getElementById('sos-countdown-overlay').classList.add('hidden'); sendSOS(); }
            }, 1000);
        };
        window.cancelSOS = () => { clearInterval(state.sosTimer); document.getElementById('sos-countdown-overlay').classList.add('hidden'); };
        window.sendSOS = async () => {
             const contact = state.profile.contact;
             let loc = { lat: 0, lng: 0 };
             // Use geo, or fallback
             if(navigator.geolocation) navigator.geolocation.getCurrentPosition(async (pos) => {
                 loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                 await pushEmergency(loc, contact);
             }, () => pushEmergency(loc, contact));
             else pushEmergency(loc, contact);
        };
        
        async function pushEmergency(loc, contact) {
            await create('emergencies', { patientId: state.user.uid, patientName: state.name, contact, location: loc, status: 'OPEN', timestamp: Date.now() });
            showToast("SOS SENT!", "success");
            document.getElementById('sos-status-box').classList.remove('hidden');
            
            // AI Analysis (Feature)
            if(apiKey) {
                const risk = await callGemini(`Analyze triage urgency for SOS. Patient: ${state.name}. History: ${state.profile.history}.`, "Return brief risk level.");
                console.log(risk);
            }
        }

        window.acceptEmergency = async (id) => {
             await update('emergencies', id, { status: 'ACCEPTED', acceptedBy: state.user.uid });
             showToast("Mission Accepted", "success");
        };
        
        function renderActiveMission(data) {
            return `
            <div class="bg-green-50 border border-green-200 p-4 rounded-xl shadow-lg transform transition-all scale-105">
                <div class="flex justify-between items-start mb-4">
                    <div><h4 class="font-bold text-green-900 text-lg"><i class="fa-solid fa-check-circle mr-2"></i>Active Mission</h4><p class="text-sm text-green-700">Patient: ${data.patientName}</p></div>
                    <a href="tel:${data.contact}" class="bg-green-100 text-green-700 w-10 h-10 rounded-full flex items-center justify-center hover:bg-green-200"><i class="fa-solid fa-phone"></i></a>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-2">
                    <a href="https://www.google.com/maps?q=${data.location.lat},${data.location.lng}" target="_blank" class="flex items-center justify-center gap-2 py-2 bg-green-600 text-white rounded-lg font-bold text-sm hover:bg-green-700">Navigate</a>
                    <button onclick="startVideoCall()" class="flex items-center justify-center gap-2 py-2 bg-white border border-green-200 text-green-700 rounded-lg font-bold text-sm hover:bg-green-50">Video Call</button>
                </div>
                 <a href="https://www.google.com/maps/search/hospitals+near+${data.location.lat},${data.location.lng}" target="_blank" class="flex items-center justify-center gap-2 py-2 w-full bg-blue-100 text-blue-700 rounded-lg font-bold text-sm hover:bg-blue-200"><i class="fa-solid fa-hospital"></i> Nearest Hospital</a>
            </div>`;
        }

        window.startVideoCall = () => document.getElementById('video-call-modal').classList.remove('hidden');
        window.endCall = () => document.getElementById('video-call-modal').classList.add('hidden');

        function initDoctor() {
            listen('emergencies', (snap) => {
                const feed = document.getElementById('doctor-feed');
                feed.innerHTML = '';
                snap.docs.forEach(d => {
                    const data = d.data();
                    if(data.status === 'OPEN') feed.innerHTML += `<div class="bg-red-50 border border-red-200 p-3 rounded flex justify-between items-center animate-pulse"><div><h4 class="font-bold text-red-800 text-sm">SOS: ${data.patientName}</h4></div><button class="px-3 py-1 bg-red-600 text-white rounded text-xs font-bold" onclick="acceptEmergency('${d.id}')">RESPOND</button></div>`;
                    else if(data.status === 'ACCEPTED' && data.acceptedBy === state.user.uid) feed.innerHTML += renderActiveMission(data);
                });
            });
            listen('appointments', (snap) => {
                 const req = document.getElementById('doctor-requests');
                 req.innerHTML = '';
                 snap.docs.forEach(d => {
                     const data = d.data();
                     if(data.status === 'pending') req.innerHTML += `<div class="bg-white border p-3 rounded flex justify-between"><h4>${data.patientName}</h4><button onclick="updateAppt('${d.id}', 'accepted')" class="text-green-600">Accept</button></div>`;
                 });
            });
        }
        
        window.updateAppt = async (id, status) => { await update('appointments', id, { status }); showToast("Updated", "info"); };

        function initVolunteer() {
            listen('emergencies', (snap) => {
                const feed = document.getElementById('volunteer-feed');
                feed.innerHTML = '';
                snap.docs.forEach(d => {
                    const data = d.data();
                    if(data.status === 'OPEN') feed.innerHTML += `<div class="bg-red-50 p-4 rounded border border-red-200"><div class="flex justify-between mb-2"><span class="font-bold text-red-800">SOS Alert</span><span class="text-xs bg-white px-2 py-1 rounded border">1.2km</span></div><p class="text-sm text-slate-700 mb-3">${data.patientName}</p><button class="w-full py-2 bg-red-600 text-white rounded font-bold text-sm" onclick="acceptEmergency('${d.id}')">RESPOND</button></div>`;
                    else if(data.status === 'ACCEPTED' && data.acceptedBy === state.user.uid) feed.innerHTML += renderActiveMission(data);
                });
            });
            listen('doctors', (snap) => {
                const list = document.getElementById('volunteer-doc-list');
                list.innerHTML = '';
                snap.docs.forEach(d => {
                    const data = d.data();
                    list.innerHTML += `<div class="p-4 bg-white border rounded flex justify-between"><div><h4 class="font-bold text-sm">${data.name}</h4><p class="text-xs text-slate-500">${data.spec}</p></div><button class="text-blue-600 font-bold text-xs">Call</button></div>`;
                });
            });
        }

        function showToast(msg, type) {
            const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<span class="font-bold text-slate-700 text-sm">${msg}</span>`;
            if(type === 'error') t.style.borderLeftColor = '#ef4444';
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
    </script>
</body>
</html>